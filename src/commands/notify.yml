description: >
  This command echos "Hello World" using file inclusion.
# What will this command do?
# Descriptions should be short, simple, and clear.
parameters:
  mentions:
    type: string
    default: ''
    description: >
      Mention users via the @ symbol: "@USER"

      If the username contains a space, the Slack ID must be used with angled
      brackets: "<@U8XXXXXXX>"
  image-url:
    type: string
    default: ''
    description: ""
steps:
  - run: echo "export GIT_COMMIT_MSG=\"`git --no-pager log -1 --pretty=format:'%s'`\"" >> $BASH_ENV
  - run:
      name: build params
      environment:
        IMAGE_URL: << parameters.image-url >>
      command: << include(scripts/build-json.sh) >>
  - when:
      condition: << parameters.image-url >>
      steps:
        - official-slack/notify:
            event: always
            mentions: << parameters.mentions >>
            custom: |
              {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "UPDATE AGONES DONE :rocket:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Branch / Tag *\t\n${CIRCLE_BRANCH}${CIRCLE_TAG}"
                    },
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Repo*\t\n${CIRCLE_PROJECT_REPONAME}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Message*\t\n${GIT_COMMIT_MSG}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Commit*\t\n${CIRCLE_SHA1:0:7}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*\t\n${CIRCLE_USERNAME}"
                      }
                    ]
                  }
                ]
              }
  - unless:
      condition: << parameters.image-url >>
      steps:
        - official-slack/notify:
            event: always
            mentions: << parameters.mentions >>
            custom: |
              {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "UPDATE AGONES DONE :rocket:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "divider"
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Branch / Tag *\t\n${CIRCLE_BRANCH}${CIRCLE_TAG}"
                    },
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Repo*\t\n${CIRCLE_PROJECT_REPONAME}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Message*\t\n${GIT_COMMIT_MSG}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Commit*\t\n${CIRCLE_SHA1:0:7}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*\t\n${CIRCLE_USERNAME}"
                      }
                    ],
                    "accessory": {
                      "type": "image",
                      "image_url": "${IMAGE_URL}",
                      "alt_text": "thumbnail"
                    }
                  }
                ]
              }
